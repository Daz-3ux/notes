# 14.1 设备专用文件(设备文件)
- 设备专用文件与系统的某个设备相对应:在内核中,每种设备类型都有与之相对应的设备驱动程序,用来处理设备的所有I/O请求
- 某些设备是真实存在的,而另一些是虚拟的,但内核会(通过设备驱动程序)提供抽象设备

- 设备类型
    1. 字符型设备:基于每个字符处理数据(例如终端与键盘)
    2. 块设备:每次处理一块数据,快的大小取决于设备类型(例如磁盘)

- 设备文件总会出现在文件系统中,位于 `/dev` 目录下

## 设备ID
- 每个设备文件都有 `主/副ID` 各一个
- 主ID表示一般的设备等级:内核根据主ID号查找与该类设备相应的驱动程序
- 副ID在一般等级中唯一标识特定设备
- 设备文件的i节点中记录了设备的主/副ID

# 14.2 磁盘和分区

## 磁盘驱动器
- 一种机械装置
- 寻道时间:等待磁道
- 旋转延迟:等待扇区
- 传输时间:等待数据传输

## 磁盘分区
- 磁盘分区可容纳任何类型的信息,通常包括:
    - 文件系统:存放常规文件
    - 数据区域:可做为`裸设备`对其进行访问
    - 交换区域:供内核的内存管理之用
- **每个分区都可包含一个文件系统**

# 14.3 文件系统
- Linux支持多种文件系统

## ext2文件系统
- 扩展系统文件二世
- 很重要

## 文件结构系统
- 文件系统中,用来分配空间的基本单位是逻辑块
- ext2中,逻辑块的大小为1024 / 2048 / 4096字节

### 磁盘分区和文件系统布局
![](https://s3.bmp.ovh/imgs/2022/05/20/e47d64c551e009cb.png)
- 引导块:只包含用来引导操作系统的信息
- 超级块:包含与文件系统有关的参数信息
    - i节点容量
    - 文件系统中逻辑块大小
    - 以逻辑块计,文件系统的大小
- i节点表:登记了关乎文件的各种信息
- 数据块:存放数据

# 14.4 i节点
维护以下信息:
- 文件类型
- 文件属主
- 文件属组
- 访问权限
- 时间戳
- 指向文件的硬链接数量
- 文件的大小(以字节为单位)
- 实际分配给文件的块数量
- 指向文件数据块的指针

## ext2的i节点和数据块指针
- DB IPB 2IPB 3IPB

# 14.5 虚拟文件系统(VFS)
- 一种内核特性
- 为文件系统操作建立抽象层来与应用程序交互
![](https://s3.bmp.ovh/imgs/2022/05/20/9fb8e2ca3a404339.png)
- VFS针对文件系统定义了一套通用接口
- 每种文件系统都会提供VFS接口的实现

# 14.6 日志文件系统
- 一旦系统崩溃，系统可以重放(replay)日志文件，并迅速将文件系统恢复到一致状态
- 日志文件系统的最大优点在于系统崩溃后，无需像常规 UNIX 文件系统那样对文件系统进行漫长的一致性检查
- 对于大型系统崩溃后重启很有用
- 但增加了文件更新的时长

# 14.7 单根目录层级和挂载点
- Linux上所有文件系统中的文件都位于单根目录树下,树根为 `根目录'/'`
- 挂载点可通过命令变更
![](https://s3.bmp.ovh/imgs/2022/05/20/8fe38ecc3e1377ef.png)

# 14.8 文件系统的挂载和卸载
- 挂载文件系统:mount()
- 卸载文件系统:umount()和umount2()

# 14.9 高级挂载特性

## 在多个挂载点挂载文件系统
- 在一个挂载点下对目录子树做出改变,同样可见于其他挂载点

## 多次挂载统一挂载点
- 每次新挂载都会隐藏之前可见于挂载点下的目录子树。
- 卸载最后一次挂载时，挂载点下上次挂载的内容会再次显示

## 基于每次挂载的挂载标致
- 文件系统和挂载点不再是一一对应的关系
- mountflag可根据每次挂载来设置

## 绑定挂载
- 指在文件系统目录层级的另一处挂载目录或文件
- 文件或目录将在两处同时可见
- 绑定挂载有些类似于硬链接，但存在两个方面的差异:
    - 绑定挂载可以跨越多个文件系统挂载点，甚至不拘于 chroot 监禁区（ jail）
    - 可针对目录执行绑定挂载

## 递归绑定挂载

# 14.10 虚拟内现文件系统:tmpfs
- Linux支持驻留于内存中的虚拟文件系统
- tmpfs 文件系统是一个 Linux 内核的可选组件，通过 CONFIG_TMPFS 选项加以配置
- 由内核内部挂载的隐形 tmpfs 文件系统，用于实现System V 共享内存 和 共享匿名内存映射
- 挂载于/dev/shm 的 tmpfs 文件系统,为 glibc 用以实现 POSIX 共享内存和 POSIX 信号量

# 14.11 获取与文件系统相关的信息:statvfs()
- statvfs()和 fstatvfs()库函数能够获得与已挂载文件系统有关的信息