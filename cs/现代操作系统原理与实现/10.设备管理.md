# 10.1 计算机设备的连接和通信

## 10.1.1 设备的连接: 总线
- bus
- 设备通过总线与 CPU 相连,常见的设备总线:
  - AMBA
  - PCIe
- 设备和总线的工作频率一般低于 CPU

### AMBA 总线
- 总线规范: `Adcanced Micro-controller Bus Architecture` 规范
  - 高级微控制器总线结构规范
- AMBA 总线规范一般包括三种总线:
  - `高级高性能总线`
    - Advanced High-Performen: `AHB`
    - 连接其他高性能 IP 核, 片上和片外内存 以及 中断控制器 等高性能模块
  - `高级系统总线`
    - Advanced System Bus: `ASB`
    - 不必使用 `AHB` 但又需要 `高性能`,可以部分 `降低功耗`
  - `高级设备总线`
    - Advanced Peripheral Bus: `APB`
    - 连接`低速`设备,降低功耗的`精简接口`
- 还包含`高级可扩展接口(Advanced eXtensible Interface: AXI)`
  - 高宽带,低延迟的片内总线

### PCI 总线
- 设备组件互联标准
  - Peripheral Component Interconnect: PCI
- PCIe
  - PCI express
  - 解决了数据传输速率过高时,PCI 所采用的并行线路之间会相互干扰

## 10.1.2 可编程I/O
- CPU 通常以读写设备寄存器的方式与设备进行通信
- 设备寄存器分为以下类型:
  - 控制寄存器: 接收来自驱动程序的命令
  - 状态寄存器: 反馈当前设备的工作状态
  - 输入/输出寄存器: 用于驱动和设备之间的数据交互
- 访问设备寄存器的两种方式:
  - `内存映射`
    - Memory-Mapped I/O: MMIO
  - `端口映射`
    - Port-Mapped I/O: PMIO
  - 这两种方式都称为`可编程I/O`
    - Programmed I/O: PIO

## 10.1.3 高效数据传输: DMA
- PIO 需要 CPU 主动搬运数据,大量 I/O 时会导致大量占用CPU
- 如何解放CPU?
  - 直接内存访问!!
- 直接内存访问:
  - Direct Memory Access: `DMA`
  - 在设备和内存之间主要且更高效的数据传输形式(设备与内存直接交互)
  - 允许设备`绕过`处理器直接读写系统内存的数据
  - 提高了处理器资源的利用率
- DMA的发起者:
  - `处理器`
  - `I/O设备`
  - 在一些总线中,DMA 的发起还需要 `DMA控制器` 的参与
    - `DMA 控制器`和`处理器`与内存连接到`同一系统总线(system bus)`
    - DMA 控制器相当于首发双方的第三方,称其为`第三方DMA`机制: `标准DMA`
  - 部分总线允许设备直接获取总线控制权并进行 DMA 操作
    - `第一方 DMA`
    - 如果多个设备希望同时进行DMA,总线控制器需进行仲裁，保证统一时间只允许一个设备进行 DMA

## 10.1.4 设备地址翻译: IOMMU
- 设备进行DMA时访问的内存地址是 `总线地址(bus address)`
  - 设备和内存之间的`输入输出内存管理单元(Input-Output Memory Management Unit: IOMMU)`负责将总线地址翻译为物理地址

# 10.2 设备的识别

## 10.2.1 设备树

## 10.2.2 ACPI

# 10.3 设备的中断

## 10.3.1 中断控制器

## 10.3.2 中断的基本概念

## 10.3.3 中断处理:以 Linux 上下半部的机制为例

# 10.4 设备驱动与设备驱动模型

## 10.4.1 设备驱动

## 10.4.2 设备驱动模型

# 10.5 Linux设备驱动模型

## 10.5.1 Linux的设备抽象

## 10.5.2 Linux的设备驱动模型

## 10.5.3 Linux驱动的动态管理

## 10.5.4 Linux的 sysfs文件系统

