- 多线程协作来实现应用和系统是一种被广泛使用的开发方法,主要有以下三点优势:
  - 功能模块化
  - 增强模块间隔离
  - 提高应用容错能力
- `进程间通信`(`IPC`)是`多进程协作`的基础

# 7.1 进程间通信基础

## 7.1.1 一个简单的进程间通信设计
- `通信模型`
  - 进程间参与通信的进程以及他们通信的方式
- `传递数据`
  - 一种常见的通信数据的抽象:消息
    - 消息一般包含一个`头部`和一个`数据段`
- `通信过程`

## 7.1.2 数据传递
- 消息传递的基本接口
  - 发送消息 Send
  - 接收消息 Recv
  - 远程过程调用 RPC(Remote Procedure Call)
  - 回复消息 Reply

- 共享内存和操作系统辅助传递的对比
  - 共享内存优于操作系统辅助传递之处:
    - `共享内存`可以实现理论上的`零拷贝传输`:通过`CPU访存指令`来实现
    - `操作系统辅助传递`通常需要先从发送者用户态内存拷贝到内核态,再从内核态拷贝到接收者用户态内存,包含`两次拷贝`(借助内存映射可做到只一次拷贝)
  - 操作系统辅助传递优于共享内存之处:
    - 操作系统辅助传递的抽象更简单
    - 操作系统辅助传递安全性更强
    - 操作系统在多方通信时可简化流程且更安全

## 7.1.3 控制流转移

## 7.1.4 单向和双向
- IPC通常包含三种可能的方向
  - 仅支持单向通信
  - 仅支持双向通信
  - 单向双向均可

## 7.1.5 同步和异步
- 同步IPC
  - IPC操作会阻塞进程直到该操作完成
  - 通常是双向IPC
- 异步IPC
  - 非阻塞
  - 通过`轮询内存状态`或`注册回调函数`来获取返回结果
  - 应对并发

## 7.1.6 超时机制
- 两个特殊的超时选项
  - `永不返回`
    - 侧重功能性
  - `立即返回`
    - 侧重安全性

## 7.1.7 通信连接管理
- 如何建立一个连接
  - 直接通信
    - 信号
  - 间接通信
    - 管道

## 7.1.8 权限检查
- Linux这样的宏内核将安全检查机制和文件的权限检查机制结合在一起进行处理

- System V 进程间通信权限管理
  - `依赖于进程的用户分类`以及`基于文件的权限抽象`来判定

## 7.1.9 命名服务
- 权限的分发
  - 依靠内核态服务:`命名服务`进行处理
  - 通过`继承`来分发连接权限

# 7.2 宏内核进程间通信
- 宏内核IPC设计的主要区别在`数据抽象`上
- 应用程序往往根据对数据抽象的需求来选择具体的方案
![](https://i.imgur.com/5lSv0Qn.png)

## 7.2.1 管道进程间通信
- 管道在UNIX系列的系统中被当作`文件`

- 命名管道与匿名管道
  - 匿名管道
    - pipe + fork
  - 命名管道
    - mkfifo创建
    - 在创建过程中指定一个全局的文件名,由这个文件名指代一个具体的管道

## 7.2.2 System V 消息队列
- 为什么需要
  - 灵活
  - 多发送者多接收者
  - 为每个消息提供了类型抽象

- 结构
  - 队列的链表设计

- 基本操作
  - msgget
  - msgsnd
  - msgrcv
  - msgctl
  - 在Linux上以上四个调用均为系统调用

- Linux内核实现
  - 队列创建后除内核重启以及队列被主动删除,否则数据都会被保留
  - 队列内存空间有限制,系统管理员可更改
  - 消息在用户态和内核态之间传递时会有拷贝的开销

## 7.2.3 System V 信号量
- 为什么需要
  - 主要用作`进程间同步`

- 信号量进程间通信
  - `P`:Probeer尝试:信号量计数器减一
  - `V`:Verhoog增加:信号量计数器加一
  - V可能会唤醒因P而陷入阻塞的进程
  - 这两个操作都是`原子`的

## 7.2.4 System V 共享内存
- 为什么需要
  - 性能高
  - 大部分微内核支持共享内存机制

- 共享内存进程间通信
  - 共享内存允许一个或多个进程在其所在的虚拟地址空间中映射相同的物理内存页,从而进行通信

- Linux共享内存设计
![](https://i.imgur.com/QRU2IOc.pn)

## 7.2.5 信号进程间通信
- 为什么需要
  - 管道,消息队列,共享内存主要关注`数据传输设计`
  - 信号具有单向的`事件通知`能力
  - 信号量也有事件通知能力但需进程主动去查询

- 信号的处理和相响应
  - 内核对信号的处理一般有三种方式:
    - 忽略
    - 用户处理函数
    - 内核默认处理函数

- 信号处理函数的可重入考虑
  - 在信号处理函数的执行过程中可能会触发嵌套的信号
  - 这种嵌套需要信号处理函数是可重入的
  - 可重入函数允许多个任务并发使用,而不必担心数据的错误
  - 实现可重入函数需注意以下几点:
    - 不使用静态数据 / 静态数据对所有处理函数都是只读的
    - 尽量只使用本地数据
    - 在必须使用全局共享数据的情况下,需要保护对全局数据的访问
    - 避免在函数中修改自己的代码
    - 不调用不可重入的函数
      - 例如`malloc`
